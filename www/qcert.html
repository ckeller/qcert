<!DOCTYPE HTML>
<html lang = "en">
  <head>
    <title>Q*cert online form</title>
    <meta charset = "UTF-8" />
    <script src="../lib/qcertJS.js"></script>
    <script src="../www/qcertPreCompiler.js"></script>
    <script src="../runtime/javascript/qcert-merged-runtime.js"></script>
    <script>
      var entityMap = {
      	"&": "&amp;",
      	"<": "&lt;",
      	">": "&gt;",
      	'"': '&quot;',
      	"'": '&#39;',
      	"/": '&#x2F;'
      };
      function escapeHtml(string) {
	return String(string).replace(/[&<>"'\/]/g, function (s) {
	  return entityMap[s];
	  });
      }
      function compileButton() {
        var input = { 'source' : document.getElementById("source").value,
                      'target' : document.getElementById("target").value,
                      'exactpath' : document.getElementById("exactpath").value === "ExactPath",
                      'emitall' : document.getElementById("emitall").value === "EmitAll",
                      'ascii' : document.getElementById("charset").value === "Ascii",
                      'javaimports' : document.getElementById("java_imports").value,
                      'query' : document.getElementById("query").value };
				var useLocal = document.getElementById("localServer").checked;
				compilationResult = qcertPreCompile(input, useLocal);	
				compiledQuery = compilationResult.result;
				document.getElementById("result").innerHTML = escapeHtml(compiledQuery);
				displayAllResults(compilationResult.emitall);
			}
			function displayAllResults() {
					document.getElementById("execresult").innerHTML = escapeHtml(result);
	                }
			function performEvaluation() {
					var io = document.getElementById("io").value;
					eval(compiledQuery);
					var result = JSON.stringify(query(JSON.parse(io)));
					document.getElementById("execresult").innerHTML = escapeHtml(result);
	                }
			function executeButton() {
				var target = document.getElementById("target").value;
				if (target != "js")
				  document.getElementById("execresult").innerHTML = "Only JavaScript execution is supported at this time";
				else {
				  performEvaluation();
				}
			}		
      function clearButton() {
        document.getElementById("result").innerHTML = "";
        document.getElementById("execresult").innerHTML = "";
      }
    </script>
    <script>
      function addOption(sel, lang) {
        var opt = document.createElement("option");
        opt.setAttribute("value", lang);
        var t = document.createTextNode(lang);
        opt.appendChild(t);
        sel.appendChild(opt);
      }
      function displayAllResults(allresults) {
	for (var i=0; i<allresults.length; i++) {
	  addResult(allresults[i].file,allresults[i].lang,allresults[i].value);
	}
      }
      function addResult(file,lang,value) {
        var allres = document.getElementById("allresults");
        var l = document.createElement("b");
        var t1 = document.createTextNode(lang);
        l.appendChild(t1);
        var query = document.createElement("pre");
        var t2 = document.createTextNode(value);
        query.appendChild(t2);
        allres.appendChild(l);
        allres.appendChild(query);
      }
      function addPath() {
        var li = document.createElement("LI");
        var sel = document.createElement("SELECT");
        li.appendChild(sel);
        addOption(sel, "rule");
        addOption(sel, "camp");
        addOption(sel, "oql");
        addOption(sel, "lambda_nra");
        addOption(sel, "nra");
        addOption(sel, "nraenv");
        addOption(sel, "nnrc");
        addOption(sel, "nnrcmr");
        addOption(sel, "cldmr");
        addOption(sel, "dnnrc");
        addOption(sel, "dnnrc_typed");
        addOption(sel, "js");
        addOption(sel, "java");
        addOption(sel, "spark_rdd");
        addOption(sel, "spark_dataset");
        addOption(sel, "cloudant");
        document.getElementById("path").appendChild(li);
        return false;
      }
    </script>
		<script>
			function handleFile(files, output) {
   			if (files.length > 0) {
	  		  var file = files[0];
		  	  var reader = new FileReader();
		  	  reader.onload = function(event) {
			      document.getElementById(output).innerHTML = escapeHtml(event.target.result);
			    }
			    var text = reader.readAsText(file);
			  }
			}
		</script>
  </head>
  <body>
    <h1>Q*cert online form</h1>
    <form>
      <fieldset>
        <legend>Query compiler</legend>
        <p>
          <label>source</label>
          <select id = "source">
	      <option>rule</option>
	      <option>sql</option>
	      <option>camp</option>
	      <option>oql</option>
	      <option selected="selected">lambda_nra</option>
	      <option>nra</option>
	      <option>nraenv</option>
	      <option>nnrc</option>
	      <option>nnrcmr</option>
	      <option>cldmr</option>
	      <option>dnnrc</option>
	      <option>dnnrc_typed</option>
	      <option>js</option>
	      <option>java</option>
	      <option>spark_rdd</option>
	      <option>spark_dataset</option>
	      <option>cloudant</option>
	  </select>
	  <button onclick="return addPath()">Specify an intermediate step</button>
	  <ul id="path">
	  </ul>
          <label>target</label>
          <select id = "target">
	      <option>rule</option>
	      <option>camp</option>
	      <option>oql</option>
	      <option>lambda_nra</option>
	      <option>nra</option>
	      <option selected="selected">nraenv</option>
	      <option>nnrc</option>
	      <option>nnrcmr</option>
	      <option>cldmr</option>
	      <option>dnnrc</option>
	      <option>dnnrc_typed</option>
	      <option>js</option>
	      <option>java</option>
	      <option>spark_rdd</option>
	      <option>spark_dataset</option>
	      <option>cloudant</option>
	  </select>
        </p>
        <p>
          <label>source query (enter text or choose file)&nbsp;&nbsp&nbsp;</label><input type="file" id="sourceFile" onchange='handleFile(this.files, "query")'/>
	  <br/>
          <textarea id = "query"
                    rows = "10"
                    cols = "80" />WORLD.filter{p => p.age = 32}</textarea>
        </p>
        <p>
          <label>io (enter text or choose file)&nbsp;&nbsp;&nbsp;</label></label><input type="file" id="ioFile" onchange='handleFile(this.files, "io")'/><br/>
          <textarea id = "io"
                    rows = "10"
                    cols = "80" /></textarea>
</fieldset>
<p/>
    <button type="button"
	    onclick="compileButton()"><b>compile</b></button>
    <button type="button"
	    onclick="executeButton()"><b>execute</b></button>
    <button type="button"
	    onclick="clearButton()"><b>clear</b></button>
    <fieldset>
      <legend>Compilation Result</legend>
      <p><pre id="result"></pre></p>
    </fieldset>
    <fieldset>
      <legend>All Compilation Results</legend>
      <p id="allresults"></p>
    </fieldset>
    <fieldset>
      <legend>Execution Result</legend>
      <p><pre id="execresult"></pre></p>
    </fieldset>
    <fieldset>
      <legend>Options</legend>
        <p>
          <label>character set</label>
	  <select id = "charset">
	      <option>Ascii</option>
	      <option selected="selected">Greek</option>
	  </select>
        </p>
        <p>
          <label>compilation path</label>
	  <select id = "exactpath">
	      <option>ExactPath</option>
	      <option selected="selected">FillPath</option>
	  </select>
        </p>
        <p>
          <label>emit</label>
	  <select id = "emitall">
	      <option>EmitAll</option>
	      <option selected="selected">EmitTarget</option>
	  </select>
        </p>
        <p>
          <label>java imports</label>
          <input type = "text"
                 id = "java_imports"
                 value = "" />
        </p>
    <label><input type="checkbox" id="localServer">Use Local Server for SQL Assist</label>
    </fieldset>
    <!-- Testing area
    <fieldset>
      <legend>Languages</legend>
      <p><pre id="languages"></pre></p>
      <script>
	document.getElementById("languages").innerHTML = escapeHtml(qcertLanguages().backend);
      </script>
    </fieldset>
    <fieldset>
      <legend>Paths</legend>
      <p><pre id="paths"></pre></p>
      <script>
	document.getElementById("paths").innerHTML = escapeHtml(qcertLanguagesPath({ 'source': 'sql','target':'nnrc' }).path);
      </script>
    </fieldset>
    <fieldset>
      <legend>Optim Defaults</legend>
      <p><pre id="optims"></pre></p>
      <script>
	var optims = [];
	var optims_names = [];
	var defaults = qcertOptimDefaults().optims;
	for (var i=0; i<defaults.length; i++) {
	  optims_names.push(defaults[i].language);
	  optims.push(defaults[i]);
	}
	document.getElementById("optims").innerHTML = escapeHtml(optims_names);
      </script>
    </fieldset>
    <fieldset>
      <legend>NRAEnv Optim Defaults</legend>
      <p><pre id="nraenv"></pre></p>
      <p><pre id="nraenvphase"></pre></p>
      <p><pre id="nraenvoptims"></pre></p>
      <script>
	var nraenvoptims = [];
	for (var i=0; i<optims.length; i++) {
	  var optimlang = optims[i];
	  if (optimlang.language === "nraenv") {
	    document.getElementById("nraenv").innerHTML = escapeHtml(optimlang.language);
	      for (var j=0; j<optimlang.phases.length; j++) {
  	      var optimphase = optimlang.phases[j];
	      document.getElementById("nraenvphase").innerHTML = escapeHtml(optimphase.name);
	      for (var k=0; k<optimphase.optims.length; k++) {
	        nraenvoptims.push(optimphase.optims[k]);
  	      }
	    }
	  }
	}
	document.getElementById("nraenvoptims").innerHTML = escapeHtml(nraenvoptims);
      </script>
    </fieldset>
    -->
    </form>
  </body>
</html>
