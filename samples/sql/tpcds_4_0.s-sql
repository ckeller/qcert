(statements (query (with (as "year_total") (query (union (union (query (select (as "customer_id") (ref "c_customer_id") (as "customer_first_name") (ref "c_first_name") (as "customer_last_name") (ref "c_last_name") (as "customer_preferred_cust_flag") (ref "c_preferred_cust_flag") (as "customer_birth_country") (ref "c_birth_country") (as "customer_login") (ref "c_login") (as "customer_email_address") (ref "c_email_address") (as "dyear") (ref "d_year") (as "year_total") (function "sum" (divide (add (subtract (subtract (ref "ss_ext_list_price") (ref "ss_ext_wholesale_cost")) (ref "ss_ext_discount_amt")) (ref "ss_ext_sales_price")) 2)) (as "sale_type") "s") (from (join (join (table "customer") (table "store_sales")) (table "date_dim"))) (where (and (equal (ref "c_customer_sk") (ref "ss_customer_sk")) (equal (ref "ss_sold_date_sk") (ref "d_date_sk")))) (groupBy (ref "c_customer_id") (ref "c_first_name") (ref "c_last_name") (ref "c_preferred_cust_flag") (ref "c_birth_country") (ref "c_login") (ref "c_email_address") (ref "d_year"))) (query (select (as "customer_id") (ref "c_customer_id") (as "customer_first_name") (ref "c_first_name") (as "customer_last_name") (ref "c_last_name") (as "customer_preferred_cust_flag") (ref "c_preferred_cust_flag") (as "customer_birth_country") (ref "c_birth_country") (as "customer_login") (ref "c_login") (as "customer_email_address") (ref "c_email_address") (as "dyear") (ref "d_year") (as "year_total") (function "sum" (divide (add (subtract (subtract (ref "cs_ext_list_price") (ref "cs_ext_wholesale_cost")) (ref "cs_ext_discount_amt")) (ref "cs_ext_sales_price")) 2)) (as "sale_type") "c") (from (join (join (table "customer") (table "catalog_sales")) (table "date_dim"))) (where (and (equal (ref "c_customer_sk") (ref "cs_bill_customer_sk")) (equal (ref "cs_sold_date_sk") (ref "d_date_sk")))) (groupBy (ref "c_customer_id") (ref "c_first_name") (ref "c_last_name") (ref "c_preferred_cust_flag") (ref "c_birth_country") (ref "c_login") (ref "c_email_address") (ref "d_year")))) (query (select (as "customer_id") (ref "c_customer_id") (as "customer_first_name") (ref "c_first_name") (as "customer_last_name") (ref "c_last_name") (as "customer_preferred_cust_flag") (ref "c_preferred_cust_flag") (as "customer_birth_country") (ref "c_birth_country") (as "customer_login") (ref "c_login") (as "customer_email_address") (ref "c_email_address") (as "dyear") (ref "d_year") (as "year_total") (function "sum" (divide (add (subtract (subtract (ref "ws_ext_list_price") (ref "ws_ext_wholesale_cost")) (ref "ws_ext_discount_amt")) (ref "ws_ext_sales_price")) 2)) (as "sale_type") "w") (from (join (join (table "customer") (table "web_sales")) (table "date_dim"))) (where (and (equal (ref "c_customer_sk") (ref "ws_bill_customer_sk")) (equal (ref "ws_sold_date_sk") (ref "d_date_sk")))) (groupBy (ref "c_customer_id") (ref "c_first_name") (ref "c_last_name") (ref "c_preferred_cust_flag") (ref "c_birth_country") (ref "c_login") (ref "c_email_address") (ref "d_year")))))) (select (deref "customer_id" (ref "t_s_secyear")) (deref "customer_first_name" (ref "t_s_secyear")) (deref "customer_last_name" (ref "t_s_secyear")) (deref "customer_email_address" (ref "t_s_secyear"))) (from (join (join (join (join (join (aliasAs "t_s_firstyear" (table "year_total")) (aliasAs "t_s_secyear" (table "year_total"))) (aliasAs "t_c_firstyear" (table "year_total"))) (aliasAs "t_c_secyear" (table "year_total"))) (aliasAs "t_w_firstyear" (table "year_total"))) (aliasAs "t_w_secyear" (table "year_total")))) (where (and (and (and (and (and (and (and (and (and (and (and (and (and (and (and (and (and (and (and (and (and (equal (deref "customer_id" (ref "t_s_secyear")) (deref "customer_id" (ref "t_s_firstyear"))) (equal (deref "customer_id" (ref "t_s_firstyear")) (deref "customer_id" (ref "t_c_secyear")))) (equal (deref "customer_id" (ref "t_s_firstyear")) (deref "customer_id" (ref "t_c_firstyear")))) (equal (deref "customer_id" (ref "t_s_firstyear")) (deref "customer_id" (ref "t_w_firstyear")))) (equal (deref "customer_id" (ref "t_s_firstyear")) (deref "customer_id" (ref "t_w_secyear")))) (equal (deref "sale_type" (ref "t_s_firstyear")) "s")) (equal (deref "sale_type" (ref "t_c_firstyear")) "c")) (equal (deref "sale_type" (ref "t_w_firstyear")) "w")) (equal (deref "sale_type" (ref "t_s_secyear")) "s")) (equal (deref "sale_type" (ref "t_c_secyear")) "c")) (equal (deref "sale_type" (ref "t_w_secyear")) "w")) (equal (deref "dyear" (ref "t_s_firstyear")) 2001)) (equal (deref "dyear" (ref "t_s_secyear")) (add 2001 1))) (equal (deref "dyear" (ref "t_c_firstyear")) 2001)) (equal (deref "dyear" (ref "t_c_secyear")) (add 2001 1))) (equal (deref "dyear" (ref "t_w_firstyear")) 2001)) (equal (deref "dyear" (ref "t_w_secyear")) (add 2001 1))) (greater_than (deref "year_total" (ref "t_s_firstyear")) 0)) (greater_than (deref "year_total" (ref "t_c_firstyear")) 0)) (greater_than (deref "year_total" (ref "t_w_firstyear")) 0)) (greater_than (cases (case (when (greater_than (deref "year_total" (ref "t_c_firstyear")) 0)) (then (divide (deref "year_total" (ref "t_c_secyear")) (deref "year_total" (ref "t_c_firstyear"))))) (default (dunit))) (cases (case (when (greater_than (deref "year_total" (ref "t_s_firstyear")) 0)) (then (divide (deref "year_total" (ref "t_s_secyear")) (deref "year_total" (ref "t_s_firstyear"))))) (default (dunit))))) (greater_than (cases (case (when (greater_than (deref "year_total" (ref "t_c_firstyear")) 0)) (then (divide (deref "year_total" (ref "t_c_secyear")) (deref "year_total" (ref "t_c_firstyear"))))) (default (dunit))) (cases (case (when (greater_than (deref "year_total" (ref "t_w_firstyear")) 0)) (then (divide (deref "year_total" (ref "t_w_secyear")) (deref "year_total" (ref "t_w_firstyear"))))) (default (dunit)))))) (orderBy (ascending (deref "customer_id" (ref "t_s_secyear"))) (ascending (deref "customer_first_name" (ref "t_s_secyear"))) (ascending (deref "customer_last_name" (ref "t_s_secyear"))) (ascending (deref "customer_email_address" (ref "t_s_secyear"))))))
