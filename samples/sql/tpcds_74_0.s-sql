(statements (query (with (as "year_total") (query (union (query (select (as "customer_id") (ref "c_customer_id") (as "customer_first_name") (ref "c_first_name") (as "customer_last_name") (ref "c_last_name") (as "year") (ref "d_year") (as "year_total") (function "max" (ref "ss_net_paid")) (as "sale_type") "s") (from (join (join (table "customer") (table "store_sales")) (table "date_dim"))) (where (and (and (equal (ref "c_customer_sk") (ref "ss_customer_sk")) (equal (ref "ss_sold_date_sk") (ref "d_date_sk"))) (isIn (ref "d_year") (list 2001 (add 2001 1))))) (groupBy (ref "c_customer_id") (ref "c_first_name") (ref "c_last_name") (ref "d_year"))) (query (select (as "customer_id") (ref "c_customer_id") (as "customer_first_name") (ref "c_first_name") (as "customer_last_name") (ref "c_last_name") (as "year") (ref "d_year") (as "year_total") (function "max" (ref "ws_net_paid")) (as "sale_type") "w") (from (join (join (table "customer") (table "web_sales")) (table "date_dim"))) (where (and (and (equal (ref "c_customer_sk") (ref "ws_bill_customer_sk")) (equal (ref "ws_sold_date_sk") (ref "d_date_sk"))) (isIn (ref "d_year") (list 2001 (add 2001 1))))) (groupBy (ref "c_customer_id") (ref "c_first_name") (ref "c_last_name") (ref "d_year")))))) (select (deref "customer_id" (ref "t_s_secyear")) (deref "customer_first_name" (ref "t_s_secyear")) (deref "customer_last_name" (ref "t_s_secyear"))) (from (join (join (join (aliasAs "t_s_firstyear" (table "year_total")) (aliasAs "t_s_secyear" (table "year_total"))) (aliasAs "t_w_firstyear" (table "year_total"))) (aliasAs "t_w_secyear" (table "year_total")))) (where (and (and (and (and (and (and (and (and (and (and (and (and (and (equal (deref "customer_id" (ref "t_s_secyear")) (deref "customer_id" (ref "t_s_firstyear"))) (equal (deref "customer_id" (ref "t_s_firstyear")) (deref "customer_id" (ref "t_w_secyear")))) (equal (deref "customer_id" (ref "t_s_firstyear")) (deref "customer_id" (ref "t_w_firstyear")))) (equal (deref "sale_type" (ref "t_s_firstyear")) "s")) (equal (deref "sale_type" (ref "t_w_firstyear")) "w")) (equal (deref "sale_type" (ref "t_s_secyear")) "s")) (equal (deref "sale_type" (ref "t_w_secyear")) "w")) (equal (deref "year" (ref "t_s_firstyear")) 2001)) (equal (deref "year" (ref "t_s_secyear")) (add 2001 1))) (equal (deref "year" (ref "t_w_firstyear")) 2001)) (equal (deref "year" (ref "t_w_secyear")) (add 2001 1))) (greater_than (deref "year_total" (ref "t_s_firstyear")) 0)) (greater_than (deref "year_total" (ref "t_w_firstyear")) 0)) (greater_than (cases (case (when (greater_than (deref "year_total" (ref "t_w_firstyear")) 0)) (then (divide (deref "year_total" (ref "t_w_secyear")) (deref "year_total" (ref "t_w_firstyear"))))) (default (dunit))) (cases (case (when (greater_than (deref "year_total" (ref "t_s_firstyear")) 0)) (then (divide (deref "year_total" (ref "t_s_secyear")) (deref "year_total" (ref "t_s_firstyear"))))) (default (dunit)))))) (orderBy (ascending 2) (ascending 1) (ascending 3))))
