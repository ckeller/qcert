(statements (query (with (as "frequent_ss_items") (query (select (as "itemdesc") (function "substr" (ref "i_item_desc") 1 30) (as "item_sk") (ref "i_item_sk") (as "solddate") (ref "d_date") (as "cnt") (function "count")) (from (join (join (table "store_sales") (table "date_dim")) (table "item"))) (where (and (and (equal (ref "ss_sold_date_sk") (ref "d_date_sk")) (equal (ref "ss_item_sk") (ref "i_item_sk"))) (isIn (ref "d_year") (list 1999 (add 1999 1) (add 1999 2) (add 1999 3))))) (groupBy (function "substr" (ref "i_item_desc") 1 30) (ref "i_item_sk") (ref "d_date")) (having (greater_than (function "count") 4)))) (with (as "max_store_sales") (query (select (as "tpcds_cmax") (function "max" (ref "csales"))) (from (query (select (ref "c_customer_sk") (as "csales") (function "sum" (multiply (ref "ss_quantity") (ref "ss_sales_price")))) (from (join (join (table "store_sales") (table "customer")) (table "date_dim"))) (where (and (and (equal (ref "ss_customer_sk") (ref "c_customer_sk")) (equal (ref "ss_sold_date_sk") (ref "d_date_sk"))) (isIn (ref "d_year") (list 1999 (add 1999 1) (add 1999 2) (add 1999 3))))) (groupBy (ref "c_customer_sk")))))) (with (as "best_ss_customer") (query (select (ref "c_customer_sk") (as "ssales") (function "sum" (multiply (ref "ss_quantity") (ref "ss_sales_price")))) (from (join (table "store_sales") (table "customer"))) (where (equal (ref "ss_customer_sk") (ref "c_customer_sk"))) (groupBy (ref "c_customer_sk")) (having (greater_than (function "sum" (multiply (ref "ss_quantity") (ref "ss_sales_price"))) (multiply (divide 95 100) (query (select (all)) (from (table "max_store_sales")))))))) (select (function "sum" (ref "sales"))) (from (query (union (query (select (as "sales") (multiply (ref "cs_quantity") (ref "cs_list_price"))) (from (join (table "catalog_sales") (table "date_dim"))) (where (and (and (and (and (equal (ref "d_year") 1999) (equal (ref "d_moy") 1)) (equal (ref "cs_sold_date_sk") (ref "d_date_sk"))) (isIn (ref "cs_item_sk") (query (select (ref "item_sk")) (from (table "frequent_ss_items"))))) (isIn (ref "cs_bill_customer_sk") (query (select (ref "c_customer_sk")) (from (table "best_ss_customer"))))))) (query (select (as "sales") (multiply (ref "ws_quantity") (ref "ws_list_price"))) (from (join (table "web_sales") (table "date_dim"))) (where (and (and (and (and (equal (ref "d_year") 1999) (equal (ref "d_moy") 1)) (equal (ref "ws_sold_date_sk") (ref "d_date_sk"))) (isIn (ref "ws_item_sk") (query (select (ref "item_sk")) (from (table "frequent_ss_items"))))) (isIn (ref "ws_bill_customer_sk") (query (select (ref "c_customer_sk")) (from (table "best_ss_customer"))))))))))))
