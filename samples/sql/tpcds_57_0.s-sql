(statements (query (with (as "v1") (query (select (ref "i_category") (ref "i_brand") (ref "cc_name") (ref "d_year") (ref "d_moy") (as "sum_sales") (function "sum" (ref "cs_sales_price")) (as "avg_monthly_sales") (function (partitionBy (ref "i_category") (ref "i_brand") (ref "cc_name") (ref "d_year")) "avg" (function "sum" (ref "cs_sales_price"))) (as "rn") (function (orderBy (ascending (ref "d_year")) (ascending (ref "d_moy"))) (partitionBy (ref "i_category") (ref "i_brand") (ref "cc_name")) "rank")) (from (join (join (join (table "item") (table "catalog_sales")) (table "date_dim")) (table "call_center"))) (where (and (and (and (equal (ref "cs_item_sk") (ref "i_item_sk")) (equal (ref "cs_sold_date_sk") (ref "d_date_sk"))) (equal (ref "cc_call_center_sk") (ref "cs_call_center_sk"))) (or (or (equal (ref "d_year") 2000) (and (equal (ref "d_year") (subtract 2000 1)) (equal (ref "d_moy") 12))) (and (equal (ref "d_year") (add 2000 1)) (equal (ref "d_moy") 1))))) (groupBy (ref "i_category") (ref "i_brand") (ref "cc_name") (ref "d_year") (ref "d_moy")))) (with (as "v2") (query (select (deref "i_category" (ref "v1")) (deref "i_brand" (ref "v1")) (deref "d_year" (ref "v1")) (deref "d_moy" (ref "v1")) (deref "avg_monthly_sales" (ref "v1")) (deref "sum_sales" (ref "v1")) (as "psum") (deref "sum_sales" (ref "v1_lag")) (as "nsum") (deref "sum_sales" (ref "v1_lead"))) (from (join (join (table "v1") (aliasAs "v1_lag" (table "v1"))) (aliasAs "v1_lead" (table "v1")))) (where (and (and (and (and (and (and (and (equal (deref "i_category" (ref "v1")) (deref "i_category" (ref "v1_lag"))) (equal (deref "i_category" (ref "v1")) (deref "i_category" (ref "v1_lead")))) (equal (deref "i_brand" (ref "v1")) (deref "i_brand" (ref "v1_lag")))) (equal (deref "i_brand" (ref "v1")) (deref "i_brand" (ref "v1_lead")))) (equal (deref "cc_name" (ref "v1")) (deref "cc_name" (ref "v1_lag")))) (equal (deref "cc_name" (ref "v1")) (deref "cc_name" (ref "v1_lead")))) (equal (deref "rn" (ref "v1")) (add (deref "rn" (ref "v1_lag")) 1))) (equal (deref "rn" (ref "v1")) (subtract (deref "rn" (ref "v1_lead")) 1)))))) (select (all)) (from (table "v2")) (where (and (and (equal (ref "d_year") 2000) (greater_than (ref "avg_monthly_sales") 0)) (greater_than (cases (case (when (greater_than (ref "avg_monthly_sales") 0)) (then (divide (function "abs" (subtract (ref "sum_sales") (ref "avg_monthly_sales"))) (ref "avg_monthly_sales")))) (default (dunit))) 0.100000))) (orderBy (ascending (subtract (ref "sum_sales") (ref "avg_monthly_sales"))) (ascending 3))))
