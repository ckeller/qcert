(statements (query (with (as "ss") (query (select (ref "s_store_sk") (as "sales") (function "sum" (ref "ss_ext_sales_price")) (as "profit") (function "sum" (ref "ss_net_profit"))) (from (join (join (table "store_sales") (table "date_dim")) (table "store"))) (where (and (and (equal (ref "ss_sold_date_sk") (ref "d_date_sk")) (isBetween (ref "d_date") (cast (as "DATE") "1998-08-04") (add (cast (as "DATE") "1998-08-04") (interval "30" (day))))) (equal (ref "ss_store_sk") (ref "s_store_sk")))) (groupBy (ref "s_store_sk")))) (with (as "sr") (query (select (ref "s_store_sk") (as "returns") (function "sum" (ref "sr_return_amt")) (as "profit_loss") (function "sum" (ref "sr_net_loss"))) (from (join (join (table "store_returns") (table "date_dim")) (table "store"))) (where (and (and (equal (ref "sr_returned_date_sk") (ref "d_date_sk")) (isBetween (ref "d_date") (cast (as "DATE") "1998-08-04") (add (cast (as "DATE") "1998-08-04") (interval "30" (day))))) (equal (ref "sr_store_sk") (ref "s_store_sk")))) (groupBy (ref "s_store_sk")))) (with (as "cs") (query (select (ref "cs_call_center_sk") (as "sales") (function "sum" (ref "cs_ext_sales_price")) (as "profit") (function "sum" (ref "cs_net_profit"))) (from (join (table "catalog_sales") (table "date_dim"))) (where (and (equal (ref "cs_sold_date_sk") (ref "d_date_sk")) (isBetween (ref "d_date") (cast (as "DATE") "1998-08-04") (add (cast (as "DATE") "1998-08-04") (interval "30" (day)))))) (groupBy (ref "cs_call_center_sk")))) (with (as "cr") (query (select (ref "cr_call_center_sk") (as "returns") (function "sum" (ref "cr_return_amount")) (as "profit_loss") (function "sum" (ref "cr_net_loss"))) (from (join (table "catalog_returns") (table "date_dim"))) (where (and (equal (ref "cr_returned_date_sk") (ref "d_date_sk")) (isBetween (ref "d_date") (cast (as "DATE") "1998-08-04") (add (cast (as "DATE") "1998-08-04") (interval "30" (day)))))) (groupBy (ref "cr_call_center_sk")))) (with (as "ws") (query (select (ref "wp_web_page_sk") (as "sales") (function "sum" (ref "ws_ext_sales_price")) (as "profit") (function "sum" (ref "ws_net_profit"))) (from (join (join (table "web_sales") (table "date_dim")) (table "web_page"))) (where (and (and (equal (ref "ws_sold_date_sk") (ref "d_date_sk")) (isBetween (ref "d_date") (cast (as "DATE") "1998-08-04") (add (cast (as "DATE") "1998-08-04") (interval "30" (day))))) (equal (ref "ws_web_page_sk") (ref "wp_web_page_sk")))) (groupBy (ref "wp_web_page_sk")))) (with (as "wr") (query (select (ref "wp_web_page_sk") (as "returns") (function "sum" (ref "wr_return_amt")) (as "profit_loss") (function "sum" (ref "wr_net_loss"))) (from (join (join (table "web_returns") (table "date_dim")) (table "web_page"))) (where (and (and (equal (ref "wr_returned_date_sk") (ref "d_date_sk")) (isBetween (ref "d_date") (cast (as "DATE") "1998-08-04") (add (cast (as "DATE") "1998-08-04") (interval "30" (day))))) (equal (ref "wr_web_page_sk") (ref "wp_web_page_sk")))) (groupBy (ref "wp_web_page_sk")))) (select (ref "channel") (ref "id") (as "sales") (function "sum" (ref "sales")) (as "returns") (function "sum" (ref "returns")) (as "profit") (function "sum" (ref "profit"))) (from (aliasAs "x" (query (union (union (query (select (as "channel") "store channel" (as "id") (deref "s_store_sk" (ref "ss")) (ref "sales") (as "returns") (coalesce (ref "returns") 0) (as "profit") (subtract (ref "profit") (coalesce (ref "profit_loss") 0))) (from (join (left) (on (equal (deref "s_store_sk" (ref "ss")) (deref "s_store_sk" (ref "sr")))) (table "ss") (table "sr")))) (query (select (as "channel") "catalog channel" (as "id") (ref "cs_call_center_sk") (ref "sales") (ref "returns") (as "profit") (subtract (ref "profit") (ref "profit_loss"))) (from (join (table "cs") (table "cr"))))) (query (select (as "channel") "web channel" (as "id") (deref "wp_web_page_sk" (ref "ws")) (ref "sales") (as "returns") (coalesce (ref "returns") 0) (as "profit") (subtract (ref "profit") (coalesce (ref "profit_loss") 0))) (from (join (left) (on (equal (deref "wp_web_page_sk" (ref "ws")) (deref "wp_web_page_sk" (ref "wr")))) (table "ws") (table "wr")))))))) (groupBy (rollup "channel" "id")) (orderBy (ascending (ref "channel")) (ascending (ref "id")))))
