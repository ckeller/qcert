(statements (query (with (as "cs_ui") (query (select (ref "cs_item_sk") (as "sale") (function "sum" (ref "cs_ext_list_price")) (as "refund") (function "sum" (add (add (ref "cr_refunded_cash") (ref "cr_reversed_charge")) (ref "cr_store_credit")))) (from (join (table "catalog_sales") (table "catalog_returns"))) (where (and (equal (ref "cs_item_sk") (ref "cr_item_sk")) (equal (ref "cs_order_number") (ref "cr_order_number")))) (groupBy (ref "cs_item_sk")) (having (greater_than (function "sum" (ref "cs_ext_list_price")) (multiply 2 (function "sum" (add (add (ref "cr_refunded_cash") (ref "cr_reversed_charge")) (ref "cr_store_credit")))))))) (with (as "cross_sales") (query (select (as "product_name") (ref "i_product_name") (as "item_sk") (ref "i_item_sk") (as "store_name") (ref "s_store_name") (as "store_zip") (ref "s_zip") (as "b_street_number") (deref "ca_street_number" (ref "ad1")) (as "b_street_name") (deref "ca_street_name" (ref "ad1")) (as "b_city") (deref "ca_city" (ref "ad1")) (as "b_zip") (deref "ca_zip" (ref "ad1")) (as "c_street_number") (deref "ca_street_number" (ref "ad2")) (as "c_street_name") (deref "ca_street_name" (ref "ad2")) (as "c_city") (deref "ca_city" (ref "ad2")) (as "c_zip") (deref "ca_zip" (ref "ad2")) (as "syear") (deref "d_year" (ref "d1")) (as "fsyear") (deref "d_year" (ref "d2")) (as "s2year") (deref "d_year" (ref "d3")) (as "cnt") (function "count") (as "s1") (function "sum" (ref "ss_wholesale_cost")) (as "s2") (function "sum" (ref "ss_list_price")) (as "s3") (function "sum" (ref "ss_coupon_amt"))) (from (join (join (join (join (join (join (join (join (join (join (join (join (join (join (join (join (join (table "store_sales") (table "store_returns")) (table "cs_ui")) (aliasAs "d1" (table "date_dim"))) (aliasAs "d2" (table "date_dim"))) (aliasAs "d3" (table "date_dim"))) (table "store")) (table "customer")) (aliasAs "cd1" (table "customer_demographics"))) (aliasAs "cd2" (table "customer_demographics"))) (table "promotion")) (aliasAs "hd1" (table "household_demographics"))) (aliasAs "hd2" (table "household_demographics"))) (aliasAs "ad1" (table "customer_address"))) (aliasAs "ad2" (table "customer_address"))) (aliasAs "ib1" (table "income_band"))) (aliasAs "ib2" (table "income_band"))) (table "item"))) (where (and (and (and (and (and (and (and (and (and (and (and (and (and (and (and (and (and (and (and (and (and (equal (ref "ss_store_sk") (ref "s_store_sk")) (equal (ref "ss_sold_date_sk") (deref "d_date_sk" (ref "d1")))) (equal (ref "ss_customer_sk") (ref "c_customer_sk"))) (equal (ref "ss_cdemo_sk") (deref "cd_demo_sk" (ref "cd1")))) (equal (ref "ss_hdemo_sk") (deref "hd_demo_sk" (ref "hd1")))) (equal (ref "ss_addr_sk") (deref "ca_address_sk" (ref "ad1")))) (equal (ref "ss_item_sk") (ref "i_item_sk"))) (equal (ref "ss_item_sk") (ref "sr_item_sk"))) (equal (ref "ss_ticket_number") (ref "sr_ticket_number"))) (equal (ref "ss_item_sk") (deref "cs_item_sk" (ref "cs_ui")))) (equal (ref "c_current_cdemo_sk") (deref "cd_demo_sk" (ref "cd2")))) (equal (ref "c_current_hdemo_sk") (deref "hd_demo_sk" (ref "hd2")))) (equal (ref "c_current_addr_sk") (deref "ca_address_sk" (ref "ad2")))) (equal (ref "c_first_sales_date_sk") (deref "d_date_sk" (ref "d2")))) (equal (ref "c_first_shipto_date_sk") (deref "d_date_sk" (ref "d3")))) (equal (ref "ss_promo_sk") (ref "p_promo_sk"))) (equal (deref "hd_income_band_sk" (ref "hd1")) (deref "ib_income_band_sk" (ref "ib1")))) (equal (deref "hd_income_band_sk" (ref "hd2")) (deref "ib_income_band_sk" (ref "ib2")))) (not_equal (deref "cd_marital_status" (ref "cd1")) (deref "cd_marital_status" (ref "cd2")))) (isIn (ref "i_color") (list "maroon" "burnished" "dim" "steel" "navajo" "chocolate"))) (isBetween (ref "i_current_price") 35 (add 35 10))) (isBetween (ref "i_current_price") (add 35 1) (add 35 15)))) (groupBy (ref "i_product_name") (ref "i_item_sk") (ref "s_store_name") (ref "s_zip") (deref "ca_street_number" (ref "ad1")) (deref "ca_street_name" (ref "ad1")) (deref "ca_city" (ref "ad1")) (deref "ca_zip" (ref "ad1")) (deref "ca_street_number" (ref "ad2")) (deref "ca_street_name" (ref "ad2")) (deref "ca_city" (ref "ad2")) (deref "ca_zip" (ref "ad2")) (deref "d_year" (ref "d1")) (deref "d_year" (ref "d2")) (deref "d_year" (ref "d3"))))) (select (deref "product_name" (ref "cs1")) (deref "store_name" (ref "cs1")) (deref "store_zip" (ref "cs1")) (deref "b_street_number" (ref "cs1")) (deref "b_street_name" (ref "cs1")) (deref "b_city" (ref "cs1")) (deref "b_zip" (ref "cs1")) (deref "c_street_number" (ref "cs1")) (deref "c_street_name" (ref "cs1")) (deref "c_city" (ref "cs1")) (deref "c_zip" (ref "cs1")) (deref "syear" (ref "cs1")) (deref "cnt" (ref "cs1")) (as "s11") (deref "s1" (ref "cs1")) (as "s21") (deref "s2" (ref "cs1")) (as "s31") (deref "s3" (ref "cs1")) (as "s12") (deref "s1" (ref "cs2")) (as "s22") (deref "s2" (ref "cs2")) (as "s32") (deref "s3" (ref "cs2")) (deref "syear" (ref "cs2")) (deref "cnt" (ref "cs2"))) (from (join (aliasAs "cs1" (table "cross_sales")) (aliasAs "cs2" (table "cross_sales")))) (where (and (and (and (and (and (equal (deref "item_sk" (ref "cs1")) (deref "item_sk" (ref "cs2"))) (equal (deref "syear" (ref "cs1")) 2000)) (equal (deref "syear" (ref "cs2")) (add 2000 1))) (less_than_or_equal (deref "cnt" (ref "cs2")) (deref "cnt" (ref "cs1")))) (equal (deref "store_name" (ref "cs1")) (deref "store_name" (ref "cs2")))) (equal (deref "store_zip" (ref "cs1")) (deref "store_zip" (ref "cs2"))))) (orderBy (ascending (deref "product_name" (ref "cs1"))) (ascending (deref "store_name" (ref "cs1"))) (ascending (deref "cnt" (ref "cs2"))))))
