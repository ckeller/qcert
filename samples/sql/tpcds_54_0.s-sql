(statements (query (with (as "my_customers") (query (select (ref "c_customer_sk") (ref "c_current_addr_sk")) (from (join (join (join (aliasAs "cs_or_ws_sales" (query (union (query (select (as "sold_date_sk") (ref "cs_sold_date_sk") (as "customer_sk") (ref "cs_bill_customer_sk") (as "item_sk") (ref "cs_item_sk")) (from (table "catalog_sales"))) (query (select (as "sold_date_sk") (ref "ws_sold_date_sk") (as "customer_sk") (ref "ws_bill_customer_sk") (as "item_sk") (ref "ws_item_sk")) (from (table "web_sales")))))) (table "item")) (table "date_dim")) (table "customer"))) (where (and (and (and (and (and (and (equal (ref "sold_date_sk") (ref "d_date_sk")) (equal (ref "item_sk") (ref "i_item_sk"))) (equal (ref "i_category") "Jewelry")) (equal (ref "i_class") "consignment")) (equal (ref "c_customer_sk") (deref "customer_sk" (ref "cs_or_ws_sales")))) (equal (ref "d_moy") 3)) (equal (ref "d_year") 1999))))) (with (as "my_revenue") (query (select (ref "c_customer_sk") (as "revenue") (function "sum" (ref "ss_ext_sales_price"))) (from (join (join (join (join (table "my_customers") (table "store_sales")) (table "customer_address")) (table "store")) (table "date_dim"))) (where (and (and (and (and (and (equal (ref "c_current_addr_sk") (ref "ca_address_sk")) (equal (ref "ca_county") (ref "s_county"))) (equal (ref "ca_state") (ref "s_state"))) (equal (ref "ss_sold_date_sk") (ref "d_date_sk"))) (equal (ref "c_customer_sk") (ref "ss_customer_sk"))) (isBetween (ref "d_month_seq") (query (select (add (ref "d_month_seq") 1)) (from (table "date_dim")) (where (and (equal (ref "d_year") 1999) (equal (ref "d_moy") 3)))) (query (select (add (ref "d_month_seq") 3)) (from (table "date_dim")) (where (and (equal (ref "d_year") 1999) (equal (ref "d_moy") 3))))))) (groupBy (ref "c_customer_sk")))) (with (as "segments") (query (select (as "segment") (cast (as "INT") (divide (ref "revenue") 50))) (from (table "my_revenue")))) (select (ref "segment") (as "num_customers") (function "count") (as "segment_base") (multiply (ref "segment") 50)) (from (table "segments")) (groupBy (ref "segment")) (orderBy (ascending (ref "segment")) (ascending (ref "num_customers")))))
