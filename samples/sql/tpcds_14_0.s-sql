(statements (query (with (as "cross_items") (query (select (as "ss_item_sk") (ref "i_item_sk")) (from (join (table "item") (query (intersect (distinct) (intersect (distinct) (query (select (as "brand_id") (deref "i_brand_id" (ref "iss")) (as "class_id") (deref "i_class_id" (ref "iss")) (as "category_id") (deref "i_category_id" (ref "iss"))) (from (join (join (table "store_sales") (aliasAs "iss" (table "item"))) (aliasAs "d1" (table "date_dim")))) (where (and (and (equal (ref "ss_item_sk") (deref "i_item_sk" (ref "iss"))) (equal (ref "ss_sold_date_sk") (deref "d_date_sk" (ref "d1")))) (isBetween (deref "d_year" (ref "d1")) 1998 (add 1998 2))))) (query (select (deref "i_brand_id" (ref "ics")) (deref "i_class_id" (ref "ics")) (deref "i_category_id" (ref "ics"))) (from (join (join (table "catalog_sales") (aliasAs "ics" (table "item"))) (aliasAs "d2" (table "date_dim")))) (where (and (and (equal (ref "cs_item_sk") (deref "i_item_sk" (ref "ics"))) (equal (ref "cs_sold_date_sk") (deref "d_date_sk" (ref "d2")))) (isBetween (deref "d_year" (ref "d2")) 1998 (add 1998 2)))))) (query (select (deref "i_brand_id" (ref "iws")) (deref "i_class_id" (ref "iws")) (deref "i_category_id" (ref "iws"))) (from (join (join (table "web_sales") (aliasAs "iws" (table "item"))) (aliasAs "d3" (table "date_dim")))) (where (and (and (equal (ref "ws_item_sk") (deref "i_item_sk" (ref "iws"))) (equal (ref "ws_sold_date_sk") (deref "d_date_sk" (ref "d3")))) (isBetween (deref "d_year" (ref "d3")) 1998 (add 1998 2))))))))) (where (and (and (equal (ref "i_brand_id") (ref "brand_id")) (equal (ref "i_class_id") (ref "class_id"))) (equal (ref "i_category_id") (ref "category_id")))))) (with (as "avg_sales") (query (select (as "average_sales") (function "avg" (multiply (ref "quantity") (ref "list_price")))) (from (aliasAs "x" (query (union (union (query (select (as "quantity") (ref "ss_quantity") (as "list_price") (ref "ss_list_price")) (from (join (table "store_sales") (table "date_dim"))) (where (and (equal (ref "ss_sold_date_sk") (ref "d_date_sk")) (isBetween (ref "d_year") 1998 (add 1998 2))))) (query (select (as "quantity") (ref "cs_quantity") (as "list_price") (ref "cs_list_price")) (from (join (table "catalog_sales") (table "date_dim"))) (where (and (equal (ref "cs_sold_date_sk") (ref "d_date_sk")) (isBetween (ref "d_year") 1998 (add 1998 2)))))) (query (select (as "quantity") (ref "ws_quantity") (as "list_price") (ref "ws_list_price")) (from (join (table "web_sales") (table "date_dim"))) (where (and (equal (ref "ws_sold_date_sk") (ref "d_date_sk")) (isBetween (ref "d_year") 1998 (add 1998 2))))))))))) (select (ref "channel") (ref "i_brand_id") (ref "i_class_id") (ref "i_category_id") (function "sum" (ref "sales")) (function "sum" (ref "number_sales"))) (from (aliasAs "y" (query (union (union (query (select (as "channel") "store" (ref "i_brand_id") (ref "i_class_id") (ref "i_category_id") (as "sales") (function "sum" (multiply (ref "ss_quantity") (ref "ss_list_price"))) (as "number_sales") (function "count")) (from (join (join (table "store_sales") (table "item")) (table "date_dim"))) (where (and (and (and (and (isIn (ref "ss_item_sk") (query (select (ref "ss_item_sk")) (from (table "cross_items")))) (equal (ref "ss_item_sk") (ref "i_item_sk"))) (equal (ref "ss_sold_date_sk") (ref "d_date_sk"))) (equal (ref "d_year") (add 1998 2))) (equal (ref "d_moy") 11))) (groupBy (ref "i_brand_id") (ref "i_class_id") (ref "i_category_id")) (having (greater_than (function "sum" (multiply (ref "ss_quantity") (ref "ss_list_price"))) (query (select (ref "average_sales")) (from (table "avg_sales")))))) (query (select (as "channel") "catalog" (ref "i_brand_id") (ref "i_class_id") (ref "i_category_id") (as "sales") (function "sum" (multiply (ref "cs_quantity") (ref "cs_list_price"))) (as "number_sales") (function "count")) (from (join (join (table "catalog_sales") (table "item")) (table "date_dim"))) (where (and (and (and (and (isIn (ref "cs_item_sk") (query (select (ref "ss_item_sk")) (from (table "cross_items")))) (equal (ref "cs_item_sk") (ref "i_item_sk"))) (equal (ref "cs_sold_date_sk") (ref "d_date_sk"))) (equal (ref "d_year") (add 1998 2))) (equal (ref "d_moy") 11))) (groupBy (ref "i_brand_id") (ref "i_class_id") (ref "i_category_id")) (having (greater_than (function "sum" (multiply (ref "cs_quantity") (ref "cs_list_price"))) (query (select (ref "average_sales")) (from (table "avg_sales"))))))) (query (select (as "channel") "web" (ref "i_brand_id") (ref "i_class_id") (ref "i_category_id") (as "sales") (function "sum" (multiply (ref "ws_quantity") (ref "ws_list_price"))) (as "number_sales") (function "count")) (from (join (join (table "web_sales") (table "item")) (table "date_dim"))) (where (and (and (and (and (isIn (ref "ws_item_sk") (query (select (ref "ss_item_sk")) (from (table "cross_items")))) (equal (ref "ws_item_sk") (ref "i_item_sk"))) (equal (ref "ws_sold_date_sk") (ref "d_date_sk"))) (equal (ref "d_year") (add 1998 2))) (equal (ref "d_moy") 11))) (groupBy (ref "i_brand_id") (ref "i_class_id") (ref "i_category_id")) (having (greater_than (function "sum" (multiply (ref "ws_quantity") (ref "ws_list_price"))) (query (select (ref "average_sales")) (from (table "avg_sales")))))))))) (groupBy (rollup "channel" "i_brand_id" "i_class_id" "i_category_id")) (orderBy (ascending (ref "channel")) (ascending (ref "i_brand_id")) (ascending (ref "i_class_id")) (ascending (ref "i_category_id")))))
